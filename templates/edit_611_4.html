{% extends "base.html" %}
<script src="https://code.jquery.com/color/jquery.color-2.1.2.min.js"></script>
{% block css %}

    {% load  static %}
    <link href={% static "plugins/bower_components/bootstrap-datepicker/bootstrap-datepicker.min.css" %} rel="stylesheet"
          type="text/css"/>
    <link href={% static "plugins/bower_components/custom-select/custom-select.css" %} rel="stylesheet"
          type="text/css"/>
    <link href={% static "plugins/bower_components/switchery/dist/switchery.min.css" %} rel="stylesheet"/>
    <link href={% static "plugins/bower_components/bootstrap-select/bootstrap-select.min.css" %} rel="stylesheet"/>
    <link href={% static "plugins/bower_components/bootstrap-tagsinput/dist/bootstrap-tagsinput.css" %} rel="stylesheet"/>
    <link href={% static "plugins/bower_components/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.min.css" %}rel="stylesheet"/>
    <link href={% static "plugins/bower_components/multiselect/css/multi-select.css" %} rel="stylesheet"
          type="text/css"/>

    <style>
        label {
            text-align: right !important;
        }

        .card-a label {
        }

        {#标题分割线#}
        h3 {
            border-bottom: 1px solid rgba(120, 130, 140, 0.28);
            padding-bottom: 12px;
        }

        #comp-card label {
            width: 50%;
            padding-top: 7px;
            margin-bottom: 0;
            padding-left: 7.5px;
            padding-right: 7.5px;
            float: left;
        }

        #comp-card input {
            display: block;
            font-size: 14px;
            line-height: 1.42857143;
            width: 100%;
            background: #353c48;
            border: 1px solid rgba(120, 130, 140, 0.2);
            border-radius: 0px;
            box-shadow: none;
            color: #96a2b4;
            height: 38px;
            max-width: 100%;
            padding: 7px 12px;
            transition: all 300ms linear 0s;
        }

        #empty-row {
            display: none
        }

        .done {
            background: #00c292
        }

        .need {
            background: #03a9f3 !important;
        }
    </style>
{% endblock %}
{% block breadcum %}
    <a href="{% url 'basedata' companies.street_district %}">{{ companies.street_district }}普查数据</a>
{% endblock %}
{% block content %}
    <div class="row">

            <ul class="wizard-steps" role="tablist">


                <li class="tab1 need  {% if companies.done_611 == True %} done {% endif %}" role="tab">
                    <h4>
                        <a href="{% url 'edit_com' companies.street_district cid %}"><span>主表</span>611
                        </a>
                    </h4>
                </li>

                <li class="tab1  {% if companies.need_611_1 == True %} need {% endif %}{% if companies.done_611_1 == True and companies.need_611_1 == True %} done {% endif %}"
                    role="tab">
                    <h4>
                        {% if companies.need_611_1 == False %} <span>1</span>611-1
                        {% endif %}
                        {% if companies.need_611_1 == True %}
                            <a href="{% url 'edit_611_1' cid %}"><span>1</span>611-1
                            </a>{% endif %}
                    </h4>
                </li>


                <li class="tab2 {% if companies.need_611_2 == True %} need {% endif %}{% if companies.done_611_2 == True and companies.need_611_2 == True %} done {% endif %}"
                    role="tab">
                    <h4>
                        {% if companies.need_611_2 == False %} <span>2</span>611-2
                        {% endif %}
                        {% if companies.need_611_2 == True %}
                            <a href="{% url 'edit_611_2' cid %}"><span>2</span>611-2
                            </a>{% endif %}

                    </h4>
                </li>
                <li class="tab3 {% if companies.need_611_3 == True %} need {% endif %}{% if companies.done_611_3 == True and companies.need_611_3 == True %} done {% endif %}"
                    role="tab">
                    <h4>
                        {% if companies.need_611_3 == False %} <span>3</span>611-3
                        {% endif %}
                        {% if companies.need_611_3 == True %}
                            <a href="{% url 'edit_611_3' cid %}"><span>3</span>611-3
                            </a>{% endif %}

                    </h4>
                </li>
                <li class="tab4 now {% if companies.need_611_4 == True %} need {% endif %}{% if companies.done_611_4 == True and companies.need_611_4 == True %} done {% endif %}"
                    role="tab">
                    <h4>
                        {% if companies.need_611_4 == False %} <span>4</span>611-4
                        {% endif %}
                        {% if companies.need_611_4 == True %}
                            <a href="{% url 'edit_611_4' cid %}"><span>4</span>611-4
                            </a>{% endif %}
                    </h4>
                </li>
                <li class="tab5 {% if companies.need_611_5 == True %} need {% endif %}{% if companies.done_611_5 == True and companies.need_611_5 == True %} done {% endif %}"
                    role="tab">
                    <h4>
                        {% if companies.need_611_5 == False %} <span>5</span>611-5{% endif %}
                        {% if companies.need_611_5 == True %}
                            <a href="{% url 'edit_611_5' cid %}"><span>5</span>611-5</a>{% endif %}
                    </h4>
                </li>
                <li class="tab6 {% if companies.need_611_6 == True %} need {% endif %}{% if companies.done_611_6 == True and companies.need_611_6 == True %} done {% endif %}"
                    role="tab">
                    <h4>
                        {% if companies.need_611_6 == False %} <span>6</span>611-6{% endif %}
                        {% if companies.need_611_6 == True %}
                            <a href="{% url 'edit_611_6' cid %}"><span>6</span>611-6</a>{% endif %}
                    </h4>
                </li>
            </ul>

            <div class="col-sm-12">

                <div class="white-box">
                    <form id="base_form_611_4" method="post" novalidate>{% csrf_token %}
                    <h3 class="box-title ">非一套表企业法人主要经济指标（2018）611-4</h3>
                    <div>
                        <div class="disable-card">
                            <div class="form-group">
                                <label for="main_social_num" class="col-sm-6 control-label">统一社会信用代码</label>
                                <div class="col-sm-6">
                                    <input type="text" class="form-control" id="main_social_num"
                                           name="social_num" value="{{ companies.social_num|default_if_none:"" }}"
                                           readonly>
                                    <input type="hidden" name="main_social_num" value="{{ cid }}">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="main_org_num" class="col-sm-6 control-label">组织机构代码</label>
                                <div class="col-sm-6">
                                    <input type="text" class="form-control" id="main_org_num"
                                           name="main_org_num" value="{{ companies.org_num|default_if_none:"" }}"
                                           readonly>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="main_name" class="col-sm-6 control-label">单位详细名称</label>
                                <div class="col-sm-6">
                                    <input type="text" class="form-control compNumber" id="main_name"
                                           name="main_name" value="{{ companies.name|default_if_none:"" }}" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="complete_pay" class="col-sm-6 control-label">调查单位财务支出法固定资产投资完成额:甲*（万元）</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control" id="complete_pay"
                                       required data-error="必填项"
                                       placeholder="请输入" name="complete_pay"
                                       value="{{ fixedobj.complete_pay |default_if_none:"" }}">
                                <span class="help-block with-errors"></span>
                            </div>
                        </div>
                        <div class="form-group explain">
                            <label for="explain" class="col-sm-6 control-label">固定资产投资完成额为0 的说明情况:</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control" id="explain"
                                       placeholder="说明情况" name="explain"
                                       value="{{ fixedobj.explain |default_if_none:"" }}">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="plan_hundred"
                                   class="col-sm-6 control-label">其中：计划总投资500万元以上项目财务支出法完成资额:乙*（万元）</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control" id="plan_hundred"
                                       required data-error="必填项"
                                       placeholder="请输入" name="plan_hundred"
                                       value="{{ fixedobj.plan_hundred  |default_if_none:"" }}">
                                <span class="help-block with-errors"></span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="plan_thousand" class="col-sm-6 control-label">计划总投资5000万元以上项目（个）：丙*</label>
                            <div class="col-sm-6">
                                <input type="text" class="form-control compNumber" id="plan_thousand"
                                       name="plan_thousand"
                                       placeholder="请输入" required data-error="必填项"
                                       value="{{ count |default_if_none:"" }}">
                                <span class="help-block with-errors"></span>
                            </div>
                        </div>
                    </div>
                    </form>

                </div>

                {#                <div class="add-new-form">添加</div>#}
                {{ formset.management_form }}
                {% for form in formset %}

                    {% if  forloop.counter0 %}

                        <div id="comp-card" class="col-sm-12 white-box comp_611_4">
                            <p>机构</p>
                            {% for field in form %}
                                {% if field.name == 'id' %}
                                {% else %}
                                    <div class="form-group"
                                         {% if field.name == 'main_social_num' %}style="display: none"{% endif %}>
                                        {{ field.label_tag }}
                                        <div class="col-sm-6 value">
                                            {{ field }}
                                        </div>
                                        {{ field.errors }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    {% endif %}

                {% endfor %}
                <div id='empty-row' class='col-sm-12 white-box comp_611_4'>
                    {{ formset.empty_form.as_p }}
                </div>

                {% if  permission == True %}
                    <div class="col-sm-12 white-box ">
                        <button type="submit" id="onClickButton"
                                class="btn  btn-default btn-outline btn-danger pull-right">提交
                        </button>
                        <div style="clear:both "></div>
                    </div>
                {% endif %}
        </form>

    </div>



{% endblock %}

{% block js %}
    {% load static %}
    <script src= {% static  "plugins/bower_components/switchery/dist/switchery.min.js" %}></script>
    <script src={% static  "plugins/bower_components/custom-select/custom-select.min.js" %} type="text/javascript"></script>
    <script src={% static  "plugins/bower_components/bootstrap-select/bootstrap-select.min.js" %} type="text/javascript"></script>
    <script src={% static  "plugins/bower_components/bootstrap-tagsinput/dist/bootstrap-tagsinput.min.js" %}></script>
    <script src={% static  "plugins/bower_components/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.min.js" %}
                    type="text/javascript"></script>
    <script type="text/javascript"
            src={% static  "plugins/bower_components/multiselect/js/jquery.multi-select.js" %}></script>
    <script src={% static "js/xianmeng/edit-611-4.js" %}></script>

    <script type="text/javascript">

        function updateEmptyFormIDs(element, totalForms) {
            var thisInput = element
            // get current form input name
            var currentName = element.attr('name')
            // replace "prefix" with actual number
            var newName = currentName.replace(/__prefix__/g, totalForms)

            // update input with new name
            thisInput.attr('name', newName)
            thisInput.attr('id', "id_" + newName)


            // create a new form row id
            var newFormRow = element.closest(".comp_611_4");
            var newRowId = "row_id_" + newName
            newFormRow.attr("id", newRowId)

            // add new class for basic graphic animation
            newFormRow.addClass("new-parent-row")
            // update form group id
            var parentDiv = element.parent();
            parentDiv.attr("id", "parent_id_" + newName)

            // update label id
            var inputLabel = parentDiv.find("label")
            inputLabel.attr("for", "id_" + newName)


            // return created row
            return newFormRow
        }


        $('.add-new-form').click(function (e) {
            e.preventDefault()
            // form id like #id_form-TOTAL_FORMS
            var formId = "id_form-TOTAL_FORMS"

            // copy empty form
            var emptyRow = $("#empty-row").clone();
            // remove id from new form
            emptyRow.attr("id", null)
            // Insert row after last row

            // get starting form count for formset
            var totalForms = parseInt($('#' + formId).val());
            // create new form row from empty form row
            var newFormRow;
            emptyRow.find("input, select, textarea").each(function () {
                newFormRow = updateEmptyFormIDs($(this), totalForms)
            })


            // insert new form at the end of the last form row
            $(".comp_611_1:last").after(newFormRow)

            // update total form count (to include new row)
            $('#' + formId).val(totalForms + 1);

            // scroll page to new row
            $('html, body').animate({
                scrollTop: newFormRow.offset().top - 100
            }, 500, function () {
                // animate background color
                // requires: jQuery Color: https://code.jquery.com/color/jquery.color-2.1.2.min.js
                newFormRow.animate({
                    backgroundColor: "#fff"
                }, 1500)
            });

        });
    </script>

    <script>
        jQuery(document).ready(function () {
            // Switchery
            var elems = Array.prototype.slice.call(document.querySelectorAll('.js-switch'));
            $('.js-switch').each(function () {
                new Switchery($(this)[0], $(this).data());

            });
            // For select 2

            $(".select2").select2();
            $('.selectpicker').selectpicker();
            //判断 甲项的值
            {#console.log($('#complete_pay')[0].value)#}
            if ($('#complete_pay')[0].value == '0') {
                $('.explain').show()
            } else {
                $('.explain').hide()
            }
            $('#complete_pay').on('input propertychange', function (e) {
                console.log(this.value)
                if (this.value == '0') {
                    $('.explain').show()

                } else {
                    $('.explain').hide()
                }
            })


            $("#onClickButton").click(function () {
                var data = $("#base_form_611_4").serializeArray();
                var postData = {};
                for (var x in data) {
                    postData[data[x].name] = data[x].value;
                    {#if (data[x].value == '') {#}
                    {#    if (data[x].name == 'social_num' || data[x].name == 'main_org_num') {#}
                    {##}
                    {#    } else {#}
                    {#        toastr.error("不能有空选项");#}
                    {#        $("#" + data[x].name).parent().parent().addClass("has-error")#}
                    {#        return false}}#}
                }
                console.log(postData)
                // 审核关系
                if (postData.complete_pay == '') {
                    toastr.error("调查单位财务支出法固定资产投资完成额 未填写");
                    $("#complete_pay").parent().parent().addClass("has-error")
                    return false
                }
                if (parseInt(postData.complete_pay) < 0) {
                    toastr.error("调查单位财务支出法固定资产投资完成额 必须大于等于0");
                    return false
                }
                if (parseInt(postData.complete_pay) == 0 && postData.explain == '') {
                    toastr.error("固定资产投资完成额为0 的说明情况 必填");
                    return false
                }
                if (postData.plan_hundred == '') {
                    toastr.error("其中：计划总投资500万元以上项目财务支出法完成资额 未填写");
                    $("#plan_hundred").parent().parent().addClass("has-error")
                    return false
                }
                if (postData.count == '') {
                    toastr.error("计划总投资5000万元以上项目个数 未填写");
                    $("#count").parent().parent().addClass("has-error")
                    return false
                }

                if (parseInt(postData.complete_pay) < parseInt(postData.plan_hundred)) {
                    toastr.error("调查单位财务支出法固定资产投资完成额必须大于等于计划总投资500万元及以上项目财务支出法完成投资额");
                    $("#complete_pay").parent().parent().addClass("has-error")
                    $("#plan_hundred").parent().parent().addClass("has-error")
                    return false
                }
                if (parseInt(postData.all_invest) < parseInt(postData.start_all_invest)) {
                    toastr.error("计划总投资必须大于等于自开始累积完成投资");
                    return false
                }
                if (parseInt(postData.start_all_invest) < parseInt(postData.total_invest)) {
                    toastr.error("自开始累计完成投资必须大于等于本年完成投资");
                    return false
                }

                var next_url = '/edit_611_5/{{ cid }}/';

                $.post('/edit_611_4/{{ cid }}/?next=' + next_url, postData, function (res) {
                    {#console.log(res.msg);#}
                    if (res.code == 0) {
                        toastr.success("保存成功");
                        window.setTimeout(function () {
                            window.location.reload()
                        }, 1000);

                    } else if (res.code == -1) {
                        toastr.error('提交失败');
                    } else {
                        for (var msg1 in res.msg) {
                            toastr.error(msg1 + "," + res.msg[msg1]);
                        }
                    }
                }).fail(function (jqXHR, textStatus, errorThrown) {
                    toastr.error('提交失败请稍后重试');
                });
            })


        });

    </script>

{% endblock %}